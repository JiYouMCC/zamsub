<!DOCTYPE html>
<html lang="zh_cn">
  <head>
    <meta charset= "utf-8">
    <meta http-equiv="X-UA-Coompatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>赞服地铁通</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  </head>
  <body>
    <div class="container">
      <div class="card text-center">
        <div class="card-header"><h3>赞服地铁通</h3></div>
        <div class="card-body">
          <div class="form-inline justify-content-center">
            <div class="input-group">
              <div class="input-group-prepend">
                <div class="input-group-text">线路</div>
              </div>
              <select class="form-control" id="lines" onchange="updateStation(stations, lines);"></select>
            </div>
            <div class="input-group">
              <div class="input-group-prepend">
                <div class="input-group-text">站点</div>
              </div>
              <input class="form-control" id="stations_input" list="stations" onchange="updateInfo();" /><datalist id="stations" onchange="updateInfo();"></datalist>
            </div>
          </div>
        </div>
        <h2 class="card-title" id="s_title"></h2>
        <img id="s_img" src='img/station_none.svg' class="img-thumbnail mx-auto d-block" alt="...">
        <div class="card-body">
          <table class="table table-bordered" style="max-width: 500px;margin:auto;">
            <tbody>
              <tr>
                <td id="s_description" scope="row" colspan="2"></td>
              </tr>
              <tr>
                <th style="width:100px;">站台坐标</th>
                <td id="s_location"></td>
              </tr>
               <tr>
                <th>附近站点</th>
                <td>
                  <table class="table table-borderless table-sm">
                    <tbody id="s_near">
                    </tbody>
                  </table>
                </td>
              </tr>
              <tr>
                <th>连接线路</th>
                <td id="s_lines"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card-body"><a href="https://github.com/JiYouMCC/zamsub/issues" target="_blank"><button type="button" class="btn btn-link">纠错</button></a></div>
        <div class="card-body">Power by <a href="https://pages.github.com" target="_blank">Github Page</a></div>
      </div>
    </div>
  </body>
  <script src="js/class.js"></script>
  <script src="js/data.js"></script>
  <script type="text/javascript">
    var stations = InitStation(subData);
    var lines = InitLine(subData, stations);

    function Graph() {
      this.nodes = [];
    this.edges = {};
    this.addNode = function(node) {
        if (!this.nodes.includes(node)) {
            this.nodes.push(node);
        }

    };
    this.addEdge = function(fromNode, toNode, length) {
        if (!this.edges[fromNode]) {
            this.edges[fromNode] = {};
        }
        this.edges[fromNode][toNode] = length;
    };
}

function Dijkstra(graph, sourceName) {
    var q = [];
    var dist = {};
    var prev = {};
    var minDist = function(q, dist) {
        var minNode = undefined;
        for (var i = 0; i < q.length; i++) {
            var node = q[i];
            if (minNode == undefined) {
                minNode = node;
            } else if (dist[node] < dist[minNode]) {
                minNode = node;
            }
        }
        return minNode;
    }

    for (var i = 0; i < graph.nodes.length; i++) {
        var v = graph.nodes[i];
        dist[v] = Number.MAX_VALUE;
        prev[v] = Number.MAX_VALUE;
        q.push(v);
    }

    dist[sourceName] = 0;

    while (q.length > 0) {
        var u = minDist(q, dist);
        q.splice(q.indexOf(u), 1);
        if (graph.edges[u]) {
            for (toNodeName in graph.edges[u]) {
                var length = graph.edges[u][toNodeName];
                var alt = dist[u] + length;
                if (alt < dist[toNodeName]) {
                    dist[toNodeName] = alt;
                    prev[toNodeName] = u;
                }
            }
        }
    }
    return [dist, prev];
}

function ToArray(prev, fromNode) {
    var prevNode = prev[fromNode];
    var route = [fromNode];
    while (prevNode != Number.MAX_VALUE) {
        route.push(prevNode)
        var temp = prevNode;
        prevNode = prev[temp]
    }
    route = route.reverse();
    return route;
}

function InitGraph(data, stations) {
    var graph = new Graph();
    for (line in data['lines']) {
        for (station in data['lines'][line]['stations']) {
            graph.addNode(data['lines'][line]['stations'][station]);
        }
    }

    for (var i = 0; i < data['paths'].length; i++) {
        var edge = data['paths'][i];
        var distance = Distance(FindStation(edge[0], stations), FindStation(edge[1], stations), edge[3]);
        graph.addEdge(edge[0], edge[1], distance);
    }

    return graph;
}


    function updateStation(stations, lines) {
        var station_select = document.getElementById("stations");
        var station_select_input = document.getElementById("stations_input");
        var line_select = document.getElementById("lines");
        var lineName = line_select.value;
        station_select_input.value = '';
        station_select.innerText = '';

        if (lineName == "all") {
            for (index in stations) {
                var station = stations[index];
                var para = document.createElement("option");
                para.value = station.name;
                para.text = station.name;
                station_select.appendChild(para);
            }
            return;
        }

        var l = GetLine(lineName, lines);
        for (index in l.stations) {
            var station = l.stations[index];
            var para = document.createElement("option");
            para.value = station.name;
            para.text = station.name;
            station_select.appendChild(para);
        }
    }

    function InitDom(stations, lines) {
        var lines_dom = document.getElementById("lines");
        var para = document.createElement("option");
        para.value = 'all';
        para.text = "（所有线路）";
        lines_dom.appendChild(para);

        for (index in lines) {
            var line = lines[index];
            para = document.createElement("option");
            para.value = line.name;
            para.text = line.name;
            lines_dom.appendChild(para);
        }

        updateStation(stations, lines);
    }

    var graph = InitGraph(subData, stations);
InitDom(stations, lines);

    function updateInfo() {
      var stationName = document.getElementById("stations_input").value;
      var station = FindStation(stationName, stations);
      if (station) {
        document.getElementById("s_title").innerText = station.name;
        document.getElementById("s_img").src = "img/"+ station.img;
        document.getElementById("s_description").innerText = station.description;
        document.getElementById("s_location").innerText = "";
        for(i in station.location) {
          var locaion = station.location[i];
          document.getElementById("s_location").innerText += locaion.x + ', ' + locaion.y + ', ' + locaion.z +'\r\n'
        }

        var result = Dijkstra(graph, stationName);
        var nears = [];
        for (name in result[0]) {
          nears.push([name,result[0][name]]);
        }
        nears = nears.sort(function(a,b) {return a[1]-b[1]})
        var table = document.getElementById("s_near");
        document.getElementById("s_near").innerText = "";
        for (var i = 1; i < 6; i++) {
          var tr = document.createElement("tr");
          var td1 = document.createElement("td");
          td1.innerText = nears[i][0];
          var td2 = document.createElement("td");
          td2.innerText = nears[i][1] + "米";
          tr.appendChild(td1);
          tr.appendChild(td2);
          table.appendChild(tr);
        }

        var relatedLines = GetLines(station, lines);
        document.getElementById("s_lines").innerText = ""
        for(i in relatedLines) {
          var relatedLine = relatedLines[i];
          document.getElementById("s_lines").innerText += relatedLine.name +'\r\n';
        }
      }
    }
  </script>
</html>
